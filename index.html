<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ICONA DEL SITO (Favicon) -->
    <link rel="icon" type="image/x-icon" href="ico.ico">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0056b3">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Archivio Bollette A2A</title>
    
    <!-- Libreria PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        :root { 
            --primary: #0056b3; 
            --bg-light: #f4f4f9; 
            --border: #ddd; 
            --danger: #dc3545; 
            --success: #28a745; 
            --warning: #ffc107; 
            --dark: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg-light); color: var(--dark); }
        
        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .top-left { display: flex; align-items: center; gap: 15px; }
        .top-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        h2 { margin: 0; color: var(--primary); font-size: 1.5em; }

        .btn-new { background-color: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; display: flex; align-items: center; gap: 5px; }
        .btn-backup { background-color: white; border: 1px solid var(--border); color: #555; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .backup-group { display: flex; gap: 5px; border-left: 1px solid #eee; padding-left: 10px; margin-left: 5px; }

        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 0.75em; color: #666; font-weight: bold; margin-bottom: 2px; }
        .filter-select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.95em; cursor: pointer; background-color: #f8f9fa; min-width: 120px; }

        /* --- FORM CONTAINER --- */
        #form-wrapper { display: none; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid var(--primary); }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        
        .type-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .type-btn { padding: 8px 20px; border: 2px solid var(--primary); background: white; cursor: pointer; font-weight: bold; border-radius: 20px; transition: 0.2s; }
        .type-btn.active { background: var(--primary); color: white; }

        .pdf-section { border: 2px dashed #aecbfa; padding: 20px; text-align: center; margin-bottom: 20px; background: #f8fbff; border-radius: 8px; cursor: pointer; }
        .status-msg { margin-top: 10px; font-weight: bold; color: #555; font-size: 0.9em; }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: span 2; }
        
        label { margin-bottom: 5px; font-size: 0.85em; color: #666; font-weight: 600; }
        input, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1em; font-family: inherit; }
        .save-btn { grid-column: span 2; margin-top: 10px; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; }

        /* --- TABLE --- */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; font-weight: 700; text-transform: uppercase; font-size: 0.85em; }
        
        .tag { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; display: inline-block; min-width: 60px; text-align: center; }
        .tag-Energia { background-color: #f1c40f; color: #333; }
        .tag-Gas { background-color: #e67e22; }
        .tag-Acqua { background-color: #3498db; }
        
        .action-btn { border: none; background: none; padding: 5px; cursor: pointer; font-size: 1.1em; }
        .edit-btn { color: var(--warning); }
        .delete-btn { color: var(--danger); }
        .link-btn { color: #0066cc; text-decoration: none; font-size: 1.2em; }
        
        .empty-state { text-align: center; padding: 40px; color: #888; font-style: italic; }
        .fattura-id { font-family: monospace; font-weight: bold; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        .note-text { font-size: 0.9em; color: #666; font-style: italic; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- MOBILE RESPONSIVE (CARD VIEW) --- */
        @media screen and (max-width: 768px) {
            body { padding: 10px; font-size: 16px; }
            h2 { font-size: 1.3em; }

            .top-bar { flex-direction: column; align-items: stretch; gap: 10px; }
            .top-left { justify-content: space-between; width: 100%; }
            .top-controls { flex-direction: column; width: 100%; gap: 10px; }
            
            .filter-group { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
            .filter-select { width: 60%; text-align: right; }

            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .type-btn { flex: 1; padding: 10px 5px; font-size: 0.9em; } 

            thead { display: none; }
            
            tbody tr { 
                display: block; margin-bottom: 15px; border: 1px solid #ddd; 
                border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                background: #fff; padding: 10px;
            }

            tbody td { 
                display: flex; justify-content: space-between; align-items: center; 
                border-bottom: 1px solid #f0f0f0; padding: 8px 0; text-align: right;
            }
            
            tbody td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; }

            tbody td:nth-of-type(1)::before { content: "N. Fattura:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(2)::before { content: "Tipo:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(3)::before { content: "Scadenza:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(4)::before { content: "Periodo:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(5)::before { content: "Note:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(6)::before { content: "Consumo:"; font-weight: bold; color: #666; }
            tbody td:nth-of-type(7)::before { content: "TOTALE:"; font-weight: bold; color: var(--primary); }
            tbody td:nth-of-type(8)::before { content: "Prezzo Unit.:"; font-weight: bold; color: #666; }
            
            .action-btn { padding: 10px; font-size: 1.4em; }
            
            tfoot { display: block; }
            tfoot tr { display: flex; flex-direction: column; align-items: center; text-align: center; }
            tfoot td { display: block; border: none; padding: 5px; }
        }
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-left">
            <h2>üìÇ Archivio</h2>
            <button class="btn-new" onclick="apriFormInserimento()">‚ûï Nuova</button>
            
            <div class="backup-group">
                <button class="btn-backup" onclick="esportaDati()">‚¨áÔ∏è Export</button>
                <button class="btn-backup" onclick="document.getElementById('fileImport').click()">‚¨ÜÔ∏è Import</button>
                <input type="file" id="fileImport" accept=".json" style="display:none" onchange="importaDati(this)">
            </div>
        </div>
        
        <div class="top-controls">
            <div class="filter-group">
                <span class="filter-label">TIPO</span>
                <select id="filtroTipo" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üëÅÔ∏è Tutti</option>
                    <option value="Energia">üí° Energia</option>
                    <option value="Gas">üî• Gas</option>
                    <option value="Acqua">üíß Acqua</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">ANNO</span>
                <select id="filtroAnno" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üìÖ Tutti</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">MESE</span>
                <select id="filtroMese" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üóìÔ∏è Tutti</option>
                    <option value="01">Gennaio</option>
                    <option value="02">Febbraio</option>
                    <option value="03">Marzo</option>
                    <option value="04">Aprile</option>
                    <option value="05">Maggio</option>
                    <option value="06">Giugno</option>
                    <option value="07">Luglio</option>
                    <option value="08">Agosto</option>
                    <option value="09">Settembre</option>
                    <option value="10">Ottobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Dicembre</option>
                </select>
            </div>
        </div>
    </div>

    <!-- FORM DI INSERIMENTO -->
    <div id="form-wrapper">
        <div class="form-header">
            <h3 id="form-title" style="margin:0;">Inserisci Bolletta</h3>
            <button class="close-btn" onclick="chiudiForm()" title="Chiudi">√ó</button>
        </div>

        <div class="type-selector">
            <button class="type-btn active" onclick="selezionaTipo('Energia', this)">üí° Energia</button>
            <button class="type-btn" onclick="selezionaTipo('Gas', this)">üî• Gas</button>
            <button class="type-btn" onclick="selezionaTipo('Acqua', this)">üíß Acqua</button>
        </div>

        <div class="pdf-section" onclick="document.getElementById('filePdf').click()">
            <div style="font-size: 2em; margin-bottom: 5px;">üìÑ</div>
            <strong>Clicca per caricare il PDF</strong>
            <p style="font-size:0.8em; color:#888; margin:5px 0 0 0;">Lettura automatica dati</p>
            <input type="file" id="filePdf" accept=".pdf" style="display:none" onchange="gestisciFilePDF(this)">
            <div id="statusMsg" class="status-msg">Nessun file selezionato</div>
        </div>
        
        <form id="bollettaForm" onsubmit="salvaBolletta(event)">
            <input type="hidden" id="editId" value="">

            <div class="form-grid">
                <div class="form-group">
                    <label>Numero Fattura</label>
                    <input type="text" id="numBolletta" required>
                </div>
                <div class="form-group">
                    <label>Data Scadenza</label>
                    <input type="date" id="dataScadenza" required>
                </div>
                <div class="form-group full-width">
                    <label>Periodo di Riferimento</label>
                    <input type="text" id="periodo">
                </div>
                <div class="form-group">
                    <label>Totale da Pagare (‚Ç¨)</label>
                    <input type="number" step="0.01" id="totalePagare" oninput="calcolaMedia()" required>
                </div>
                <div class="form-group">
                    <label>Consumo (<span id="unitaMisura">kWh</span>)</label>
                    <input type="number" step="0.001" id="consumo" oninput="calcolaMedia()" required>
                </div>
                <div class="form-group">
                    <label>Prezzo Medio Unitario (‚Ç¨)</label>
                    <input type="text" id="prezzoMedio" readonly>
                </div>
                <div class="form-group full-width">
                    <label>Link PDF (Drive/Cloud)</label>
                    <input type="url" id="linkBolletta">
                </div>
                <div class="form-group full-width">
                    <label>Note</label>
                    <textarea id="noteBolletta"></textarea>
                </div>
                
                <button type="submit" class="save-btn" id="btnSalva">üíæ Salva Bolletta</button>
            </div>
        </form>
    </div>

    <!-- TABELLA DATI -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>N. Fattura</th>
                    <th>Tipo</th>
                    <th>Scadenza</th>
                    <th>Periodo</th>
                    <th>Note</th>
                    <th>Consumo</th>
                    <th>Totale</th>
                    <th>P. Unit.</th>
                    <th style="text-align: right;">Azioni</th>
                </tr>
            </thead>
            <tbody id="tabellaBody"></tbody>
            <tfoot id="tabellaFooter" style="display:none;">
                <tr>
                    <td colspan="5" style="text-align: right; color: #555;">TOTALI FILTRATI:</td>
                    <td id="footConsumo">0</td>
                    <td id="footTotale">‚Ç¨ 0.00</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">
            Nessun dato trovato.
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const DB_KEY = 'db_bollette_a2a';
        let tipoSelezionato = 'Energia'; 
        let listaBollette = [];

        // --- INIZIALIZZAZIONE ---
        window.onload = function() {
            caricaDatiLocali();
            popolaFiltroAnni(); 
            renderizzaTabella();
        };

        // --- GESTIONE DATI ---
        function caricaDatiLocali() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    listaBollette = JSON.parse(saved);
                    // Garanzia che sia sempre un array
                    if (!Array.isArray(listaBollette)) listaBollette = [];
                } catch(e) {
                    console.error("Errore parse dati", e);
                    listaBollette = [];
                }
            }
        }

        function salvaDatiLocali() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(listaBollette));
            } catch (e) {
                alert("Errore salvataggio (Memoria piena o Navigazione Privata?): " + e.message);
            }
        }

        function normalizzaID() {
            // Assicura che tutti i record abbiano un ID stringa
            listaBollette.forEach((item, index) => {
                if(!item.id) item.id = Date.now().toString() + "_" + index;
                else item.id = String(item.id);
            });
        }

        // --- EXPORT / IMPORT ---
        function esportaDati() {
            if(listaBollette.length === 0) {
                alert("Nessun dato da esportare.");
                return;
            }
            const dataStr = JSON.stringify(listaBollette, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_bollette_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importaDati(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        listaBollette = json;
                        normalizzaID(); // Ripara eventuali ID mancanti o numerici
                        salvaDatiLocali(); // SALVA SUBITO PER PERSISTENZA MOBILE
                        popolaFiltroAnni();
                        renderizzaTabella();
                        alert("Import completato! Caricati " + listaBollette.length + " elementi.");
                    } else {
                        alert("File non valido.");
                    }
                } catch (err) {
                    alert("Errore file JSON: " + err);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- INTERFACCIA E LOGICA ---
        function renderizzaTabella() {
            const tbody = document.getElementById('tabellaBody');
            const tfoot = document.getElementById('tabellaFooter');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';
            
            // Filtri
            const fTipo = document.getElementById('filtroTipo').value;
            const fAnno = document.getElementById('filtroAnno').value;
            const fMese = document.getElementById('filtroMese').value;

            const filtrati = listaBollette.filter(b => {
                const d = new Date(b.scadenza);
                const anno = d.getFullYear().toString();
                const mese = (d.getMonth() + 1).toString().padStart(2, '0');
                
                return (fTipo === 'Tutti' || b.tipo === fTipo) &&
                       (fAnno === 'Tutti' || anno === fAnno) &&
                       (fMese === 'Tutti' || mese === fMese);
            });

            if (filtrati.length === 0) {
                empty.style.display = 'block';
                tfoot.style.display = 'none';
                return;
            }
            empty.style.display = 'none';
            tfoot.style.display = 'block'; // Block per adattarsi a mobile/desktop via CSS

            // Ordina per data (pi√π recente sopra)
            filtrati.sort((a, b) => new Date(b.scadenza) - new Date(a.scadenza));

            let totCons = 0, totEur = 0;

            filtrati.forEach(b => {
                totCons += parseFloat(b.consumo) || 0;
                totEur += parseFloat(b.totale) || 0;

                const tr = document.createElement('tr');
                const dataF = new Date(b.scadenza).toLocaleDateString('it-IT');
                const eurF = parseFloat(b.totale).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
                
                // NOTA: Passiamo l'ID come stringa tra apici singoli
                tr.innerHTML = `
                    <td><span class="fattura-id">${b.numero}</span></td>
                    <td><span class="tag tag-${b.tipo}">${b.tipo}</span></td>
                    <td>${dataF}</td>
                    <td style="font-size:0.85em;">${b.periodo || '-'}</td>
                    <td><div class="note-text">${b.note || '-'}</div></td>
                    <td>${b.consumo} ${getUnita(b.tipo)}</td>
                    <td style="font-weight:bold; color:var(--dark);">${eurF}</td>
                    <td>${b.prezzoUnitario} ‚Ç¨</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <a href="${b.link || '#'}" target="_blank" class="action-btn link-btn" style="${!b.link ? 'opacity:0.2; pointer-events:none;' : ''}">üìÑ</a>
                        <button class="action-btn edit-btn" onclick="modificaBolletta('${b.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="eliminaBolletta('${b.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('footConsumo').innerText = totCons.toFixed(2);
            document.getElementById('footTotale').innerText = totEur.toLocaleString('it-IT', {style:'currency', currency:'EUR'});
        }

        function getUnita(tipo) {
            return (tipo === 'Energia') ? 'kWh' : (tipo === 'Gas') ? 'Smc' : 'mc';
        }

        function popolaFiltroAnni() {
            const sel = document.getElementById('filtroAnno');
            const curr = sel.value;
            sel.innerHTML = '<option value="Tutti">üìÖ Tutti</option>';
            
            const anni = new Set(listaBollette.map(b => new Date(b.scadenza).getFullYear()));
            Array.from(anni).sort().reverse().forEach(a => {
                if(!isNaN(a)) {
                    const opt = document.createElement('option');
                    opt.value = a; opt.innerText = a;
                    sel.appendChild(opt);
                }
            });
            if([...sel.options].some(o => o.value === curr)) sel.value = curr;
        }

        // --- CRUD FORM ---
        function apriFormInserimento() {
            document.getElementById('form-wrapper').style.display = 'block';
            document.getElementById('form-title').innerText = "Inserisci Bolletta";
            document.getElementById('bollettaForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('statusMsg').innerText = "Nessun file selezionato";
            selezionaTipo('Energia', document.querySelector('.type-btn'));
            document.getElementById('form-wrapper').scrollIntoView({ behavior: 'smooth' });
        }

        function chiudiForm() {
            document.getElementById('form-wrapper').style.display = 'none';
        }

        function selezionaTipo(tipo, btn) {
            tipoSelezionato = tipo;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            else {
                // Selezione manuale per edit
                const map = {'Energia':0, 'Gas':1, 'Acqua':2};
                const buttons = document.querySelectorAll('.type-btn');
                if(buttons[map[tipo]]) buttons[map[tipo]].classList.add('active');
            }
            document.getElementById('unitaMisura').innerText = getUnita(tipo);
        }

        function calcolaMedia() {
            const tot = parseFloat(document.getElementById('totalePagare').value);
            const cons = parseFloat(document.getElementById('consumo').value);
            const out = document.getElementById('prezzoMedio');
            if (tot > 0 && cons > 0) out.value = (tot / cons).toFixed(4);
            else out.value = '';
        }

        function salvaBolletta(e) {
            e.preventDefault();
            const idEdit = document.getElementById('editId').value;
            
            const obj = {
                // Se √® un edit, mantieni l'ID, altrimenti ne crei uno nuovo stringa
                id: idEdit ? String(idEdit) : Date.now().toString(),
                numero: document.getElementById('numBolletta').value,
                tipo: tipoSelezionato,
                scadenza: document.getElementById('dataScadenza').value,
                periodo: document.getElementById('periodo').value,
                totale: parseFloat(document.getElementById('totalePagare').value),
                consumo: parseFloat(document.getElementById('consumo').value),
                prezzoUnitario: document.getElementById('prezzoMedio').value,
                link: document.getElementById('linkBolletta').value,
                note: document.getElementById('noteBolletta').value
            };

            if (idEdit) {
                const idx = listaBollette.findIndex(b => String(b.id) === String(idEdit));
                if (idx !== -1) listaBollette[idx] = obj;
            } else {
                listaBollette.push(obj);
            }

            salvaDatiLocali();
            renderizzaTabella();
            popolaFiltroAnni();
            chiudiForm();
        }

        function modificaBolletta(id) {
            // Conversione stringa per sicurezza
            const item = listaBollette.find(b => String(b.id) === String(id));
            if (!item) { alert("Errore: elemento non trovato."); return; }

            apriFormInserimento();
            document.getElementById('form-title').innerText = "Modifica Bolletta";
            document.getElementById('editId').value = item.id;
            
            document.getElementById('numBolletta').value = item.numero;
            document.getElementById('dataScadenza').value = item.scadenza;
            document.getElementById('periodo').value = item.periodo;
            document.getElementById('totalePagare').value = item.totale;
            document.getElementById('consumo').value = item.consumo;
            document.getElementById('prezzoMedio').value = item.prezzoUnitario;
            document.getElementById('linkBolletta').value = item.link || '';
            document.getElementById('noteBolletta').value = item.note || '';
            
            selezionaTipo(item.tipo, null);
        }

        function eliminaBolletta(id) {
            if(confirm("Eliminare definitivamente?")) {
                listaBollette = listaBollette.filter(b => String(b.id) !== String(id));
                salvaDatiLocali();
                renderizzaTabella();
                popolaFiltroAnni();
            }
        }

        // --- PDF STUB ---
        async function gestisciFilePDF(input) {
            const file = input.files[0];
            if(!file) return;
            const msg = document.getElementById('statusMsg');
            msg.innerText = "Simulazione lettura PDF...";
            msg.style.color = "orange";
            
            // Qui andrebbe la logica complessa di parsing
            setTimeout(() => {
                msg.innerText = "Lettura completata (Compilare campi mancanti)";
                msg.style.color = "green";
            }, 1000);
        }
    </script>
</body>
</html>
