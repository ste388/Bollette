<!DOCTYPE html>
<html lang="it">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- ICONA DEL SITO (Favicon) -->
<link rel="icon" type="image/x-icon" href="ico.ico">

<!-- CONFIGURAZIONE PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0056b3">

<!-- SUPPORTO iOS (Apple) -->
<!-- Qui mettiamo il nome corretto del tuo file PNG -->
<link rel="apple-touch-icon" href="icons/icon-192x192.png">


    <title>Archivio Bollette A2A</title>
    
    <!-- Libreria PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        :root { 
            --primary: #0056b3; 
            --bg-light: #f4f4f9; 
            --border: #ddd; 
            --danger: #dc3545; 
            --success: #28a745; 
            --warning: #ffc107; 
            --dark: #333;
            --info: #17a2b8;
        }
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg-light); color: var(--dark); }
        
        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .top-left { display: flex; align-items: center; gap: 15px; }
        .top-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        h2 { margin: 0; color: var(--primary); font-size: 1.5em; }

        .btn-new { background-color: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; display: flex; align-items: center; gap: 5px; }
        .btn-new:hover { background-color: #218838; }

        /* Pulsanti Backup */
        .btn-backup { background-color: white; border: 1px solid var(--border); color: #555; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-backup:hover { background-color: #e9ecef; color: var(--dark); border-color: #bbb; }
        .backup-group { display: flex; gap: 5px; border-left: 1px solid #eee; padding-left: 10px; margin-left: 5px; }

        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 0.75em; color: #666; font-weight: bold; margin-bottom: 2px; }
        .filter-select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.95em; cursor: pointer; background-color: #f8f9fa; min-width: 120px; }
        .filter-select:hover { border-color: var(--primary); }

        /* --- FORM CONTAINER --- */
        #form-wrapper { display: none; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid var(--primary); }
        
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .close-btn:hover { color: var(--danger); }

        .type-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .type-btn { padding: 8px 20px; border: 2px solid var(--primary); background: white; cursor: pointer; font-weight: bold; border-radius: 20px; transition: 0.2s; }
        .type-btn:hover { background: #e6f0ff; }
        .type-btn.active { background: var(--primary); color: white; }

        .pdf-section { border: 2px dashed #aecbfa; padding: 20px; text-align: center; margin-bottom: 20px; background: #f8fbff; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .pdf-section:hover { background: #eef5ff; border-color: var(--primary); }
        .status-msg { margin-top: 10px; font-weight: bold; color: #555; font-size: 0.9em; }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: span 2; }
        
        label { margin-bottom: 5px; font-size: 0.85em; color: #666; font-weight: 600; }
        input, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1em; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; cursor: not-allowed; }
        
        textarea { resize: vertical; min-height: 60px; }

        .save-btn { grid-column: span 2; margin-top: 10px; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; }
        .save-btn:hover { background: #004494; }

        /* --- TABLE --- */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; font-weight: 700; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px; }
        tr:hover { background-color: #f9f9f9; }

        tfoot tr { background-color: #e3e8ee; border-top: 2px solid var(--primary); font-weight: bold; }
        tfoot td { color: var(--primary); font-size: 1.1em; }
        
        .tag { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; display: inline-block; min-width: 60px; text-align: center; }
        .tag-Energia { background-color: #f1c40f; color: #333; }
        .tag-Gas { background-color: #e67e22; }
        .tag-Acqua { background-color: #3498db; }
        
        .action-btn { border: none; background: none; padding: 5px; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .edit-btn { color: var(--warning); }
        .delete-btn { color: var(--danger); }
        .link-btn { color: #0066cc; text-decoration: none; font-size: 1.2em; }
        
        .empty-state { text-align: center; padding: 40px; color: #888; font-style: italic; }
        .fattura-id { font-family: monospace; font-weight: bold; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        .note-text { font-size: 0.9em; color: #666; font-style: italic; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
		
		
		    /* --- STILE MOBILE (RESPONSIVE) --- */
    @media screen and (max-width: 768px) {
        
        /* 1. Adattiamo il corpo della pagina */
        body { padding: 10px; font-size: 16px; } /* Font pi√π leggibile */
        h2 { font-size: 1.3em; }

        /* 2. Top Bar: Tutto in colonna */
        .top-bar { flex-direction: column; align-items: stretch; gap: 10px; }
        .top-left { justify-content: space-between; width: 100%; }
        .top-controls { flex-direction: column; width: 100%; gap: 10px; }
        
        /* I filtri occupano tutta la larghezza */
        .filter-group { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
        .filter-select { width: 60%; text-align: right; }

        /* 3. Form: 1 sola colonna invece di 2 */
        .form-grid { grid-template-columns: 1fr; } /* 1 colonna */
        .full-width { grid-column: span 1; } /* Reset dello span */
        
        /* Pulsanti tipo pi√π grandi per il tocco */
        .type-btn { flex: 1; padding: 10px 5px; font-size: 0.9em; } 

        /* 4. TRASFORMAZIONE TABELLA IN "CARDS" */
        /* Nascondiamo l'intestazione della tabella classica */
        thead { display: none; }
        
        /* Trasformiamo le righe in "Schede" */
        tbody tr { 
            display: block; 
            margin-bottom: 15px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background: #fff;
            padding: 10px;
        }

        /* Trasformiamo le celle in righe flessibili */
        tbody td { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #f0f0f0; 
            padding: 8px 0;
            text-align: right;
        }
        
        tbody td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; }

        /* Aggiungiamo le etichette via CSS prima di ogni dato */
        tbody td:nth-of-type(1)::before { content: "Fattura:"; font-weight: bold; color: #666; text-align: left; }
        tbody td:nth-of-type(2)::before { content: "Tipo:"; font-weight: bold; color: #666; }
        tbody td:nth-of-type(3)::before { content: "Scadenza:"; font-weight: bold; color: #666; }
        tbody td:nth-of-type(4)::before { content: "Periodo:"; font-weight: bold; color: #666; }
        tbody td:nth-of-type(5)::before { content: "Note:"; font-weight: bold; color: #666; }
        tbody td:nth-of-type(6)::before { content: "Consumo:"; font-weight: bold; color: #666; }
        tbody td:nth-of-type(7)::before { content: "TOTALE:"; font-weight: bold; color: var(--primary); }
        tbody td:nth-of-type(8)::before { content: "Prezzo Unit.:"; font-weight: bold; color: #666; }
        
        /* Nascondiamo il footer della tabella (i totali) o lo adattiamo */
        tfoot { display: block; }
        tfoot tr { display: flex; flex-direction: column; align-items: center; text-align: center; }
        tfoot td { display: block; border: none; padding: 5px; }
        tfoot td::before { display: none; } /* Rimuovi etichette automatiche nel footer */
        
        /* Icone azioni pi√π grandi */
        .action-btn { padding: 10px; font-size: 1.4em; }
    }

		
		
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-left">
            <h2>üìÇ Archivio</h2>
            <button class="btn-new" onclick="apriFormInserimento()">‚ûï Nuova</button>
            
            <!-- PULSANTI EXPORT / IMPORT -->
            <div class="backup-group">
                <button class="btn-backup" onclick="esportaDati()" title="Scarica backup">‚¨áÔ∏è Export</button>
                <button class="btn-backup" onclick="document.getElementById('fileImport').click()" title="Carica backup">‚¨ÜÔ∏è Import</button>
                <input type="file" id="fileImport" accept=".json" style="display:none" onchange="importaDati(this)">
            </div>
        </div>
        
        <div class="top-controls">
            <div class="filter-group">
                <span class="filter-label">TIPO UTENZA</span>
                <select id="filtroTipo" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üëÅÔ∏è Tutti</option>
                    <option value="Energia">üí° Energia</option>
                    <option value="Gas">üî• Gas</option>
                    <option value="Acqua">üíß Acqua</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">ANNO SCADENZA</span>
                <select id="filtroAnno" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üìÖ Tutti gli anni</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">MESE SCADENZA</span>
                <select id="filtroMese" class="filter-select" onchange="renderizzaTabella()">
                    <option value="Tutti">üóìÔ∏è Tutto l'anno</option>
                    <option value="01">Gennaio</option>
                    <option value="02">Febbraio</option>
                    <option value="03">Marzo</option>
                    <option value="04">Aprile</option>
                    <option value="05">Maggio</option>
                    <option value="06">Giugno</option>
                    <option value="07">Luglio</option>
                    <option value="08">Agosto</option>
                    <option value="09">Settembre</option>
                    <option value="10">Ottobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Dicembre</option>
                </select>
            </div>
        </div>
    </div>

    <!-- FORM DI INSERIMENTO -->
    <div id="form-wrapper">
        <div class="form-header">
            <h3 id="form-title" style="margin:0;">Inserisci Bolletta</h3>
            <button class="close-btn" onclick="chiudiForm()" title="Chiudi">√ó</button>
        </div>

        <div class="type-selector">
            <button class="type-btn active" onclick="selezionaTipo('Energia', this)">üí° Energia</button>
            <button class="type-btn" onclick="selezionaTipo('Gas', this)">üî• Gas</button>
            <button class="type-btn" onclick="selezionaTipo('Acqua', this)">üíß Acqua</button>
        </div>

        <div class="pdf-section" onclick="document.getElementById('filePdf').click()">
            <div style="font-size: 2em; margin-bottom: 5px;">üìÑ</div>
            <strong>Clicca per caricare il PDF (Lettura Dati)</strong>
            <p style="font-size:0.8em; color:#888; margin:5px 0 0 0;">Il sistema riconoscer√† automaticamente i dati</p>
            <input type="file" id="filePdf" accept=".pdf" style="display:none" onchange="gestisciFilePDF(this)">
            <div id="statusMsg" class="status-msg">Nessun file selezionato</div>
        </div>
        
        <form id="bollettaForm" onsubmit="salvaBolletta(event)">
            <input type="hidden" id="editId" value="">

            <div class="form-grid">
                <div class="form-group">
                    <label>Numero Fattura</label>
                    <input type="text" id="numBolletta" required placeholder="Es. 2025...">
                </div>
                <div class="form-group">
                    <label>Data Scadenza</label>
                    <input type="date" id="dataScadenza" required>
                </div>
                <div class="form-group full-width">
                    <label>Periodo di Riferimento</label>
                    <input type="text" id="periodo" placeholder="Es. 01/01/2024 - 31/01/2024">
                </div>
                <div class="form-group">
                    <label>Totale da Pagare (‚Ç¨)</label>
                    <input type="number" step="0.01" id="totalePagare" oninput="calcolaMedia()" required>
                </div>
                <div class="form-group">
                    <label>Consumo Fatturato (<span id="unitaMisura">kWh</span>)</label>
                    <input type="number" step="0.001" id="consumo" oninput="calcolaMedia()" required>
                </div>
                <div class="form-group">
                    <label>Prezzo Medio Unitario (‚Ç¨)</label>
                    <input type="text" id="prezzoMedio" readonly>
                </div>
                
                <div class="form-group full-width">
                    <label>Link PDF (Google Drive / Cloud)</label>
                    <input type="url" id="linkBolletta" placeholder="https://drive.google.com/file/d/...">
                </div>

                <div class="form-group full-width">
                    <label>Note / Commenti</label>
                    <textarea id="noteBolletta" placeholder="Es. Conguaglio, pagata in ritardo..."></textarea>
                </div>
                
                <button type="submit" class="save-btn" id="btnSalva">üíæ Salva Bolletta</button>
            </div>
        </form>
    </div>

    <!-- TABELLA DATI -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>N. Fattura</th>
                    <th>Tipo</th>
                    <th>Scadenza</th>
                    <th>Periodo</th>
                    <th>Note</th>
                    <th>Consumo</th>
                    <th>Totale</th>
                    <th>P. Unit.</th>
                    <th style="text-align: right;">Azioni</th>
                </tr>
            </thead>
            <tbody id="tabellaBody"></tbody>
            <tfoot id="tabellaFooter" style="display:none;">
                <tr>
                    <td colspan="5" style="text-align: right; color: #555;">TOTALI FILTRATI:</td>
                    <td id="footConsumo">0</td>
                    <td id="footTotale">‚Ç¨ 0.00</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">
            Nessuna bolletta trovata con questi filtri.
        </div>
    </div>

    <script>
        // --- STATO APPLICAZIONE ---
        let tipoSelezionato = 'Energia'; 
        let listaBollette = [];
        const mesiMap = { 'gennaio': '01', 'febbraio': '02', 'marzo': '03', 'aprile': '04', 'maggio': '05', 'giugno': '06', 'luglio': '07', 'agosto': '08', 'settembre': '09', 'ottobre': '10', 'novembre': '11', 'dicembre': '12' };

        window.onload = function() {
            caricaDatiLocali();
            popolaFiltroAnni(); 
            renderizzaTabella();
        };

        function caricaDatiLocali() {
            const saved = localStorage.getItem('db_bollette_a2a');
            if (saved) {
                listaBollette = JSON.parse(saved);
            }
        }

               function salvaDatiLocali() {
            try {
                const datiStringa = JSON.stringify(listaBollette);
                localStorage.setItem('db_bollette_a2a', datiStringa);
                
                // Opzionale: piccolo feedback visivo console per debug
                console.log("Salvataggio OK: " + listaBollette.length + " elementi.");
            } catch (e) {
                // Questo errore compare se sei in Navigazione Privata 
                // o se la memoria √® piena/disabilitata
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    alert("‚ö†Ô∏è ATTENZIONE: Memoria piena o Navigazione Privata! I dati non verranno salvati se chiudi la pagina.");
                } else if (e.name === 'SecurityError') {
                    alert("‚ö†Ô∏è ATTENZIONE: Sicurezza Browser! Non puoi salvare dati se apri il file locale. Devi caricarlo su un server (es. GitHub Pages).");
                } else {
                    alert("Errore salvataggio: " + e.message);
                }
            }
        }

        // --- EXPORT / IMPORT FUNZIONI ---
        function esportaDati() {
            if(listaBollette.length === 0) {
                alert("Non ci sono dati da esportare!");
                return;
            }
            const dataStr = JSON.stringify(listaBollette, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const dataOggi = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `backup_bollette_${dataOggi}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

               function importaDati(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();

            // Questa funzione viene eseguita SOLO quando il file √® stato letto completamente
            reader.onload = function(e) {
                try {
                    const jsonImportato = JSON.parse(e.target.result);
                    
                    // Verifica base che sia un array
                    if (!Array.isArray(jsonImportato)) {
                        alert("Errore: Il file selezionato non √® un backup valido.");
                        return;
                    }

                    // 1. Aggiorna la variabile globale
                    listaBollette = jsonImportato;

                    // 2. IMPORTANTE: Salva subito nel LocalStorage per persistere i dati
                    salvaDatiLocali();

                    // 3. Aggiorna l'interfaccia
                    popolaFiltroAnni();
                    renderizzaTabella();
                    
                    alert("Backup importato con successo! Trovate " + listaBollette.length + " bollette.");

                } catch (err) {
                    console.error("Errore import:", err);
                    alert("Errore nella lettura del file JSON. Assicurati che sia corretto.");
                }
            };

            reader.readAsText(file);
            // Resetta l'input per permettere di ricaricare lo stesso file se serve
            inputElement.value = ''; 
        }

        // --- GESTIONE INTERFACCIA E TABELLA ---

        function renderizzaTabella() {
            const tbody = document.getElementById('tabellaBody');
            const tfoot = document.getElementById('tabellaFooter');
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';
            
            // Filtri
            const tipo = document.getElementById('filtroTipo').value;
            const anno = document.getElementById('filtroAnno').value;
            const mese = document.getElementById('filtroMese').value;

            // Filtra la lista
            const datiFiltrati = listaBollette.filter(b => {
                const dataB = new Date(b.scadenza);
                const annoB = dataB.getFullYear().toString();
                // Nota: getMonth() restituisce 0-11, aggiungiamo 1 e padding
                const meseB = (dataB.getMonth() + 1).toString().padStart(2, '0');

                const checkTipo = (tipo === 'Tutti') || (b.tipo === tipo);
                const checkAnno = (anno === 'Tutti') || (annoB === anno);
                const checkMese = (mese === 'Tutti') || (meseB === mese);

                return checkTipo && checkAnno && checkMese;
            });

            // Gestione stato vuoto
            if (datiFiltrati.length === 0) {
                emptyState.style.display = 'block';
                tfoot.style.display = 'none';
                return;
            } else {
                emptyState.style.display = 'none';
                tfoot.style.display = 'table-footer-group';
            }

            // Ordina per scadenza decrescente (pi√π recenti in alto)
            datiFiltrati.sort((a, b) => new Date(b.scadenza) - new Date(a.scadenza));

            let sommaConsumo = 0;
            let sommaTotale = 0;

            datiFiltrati.forEach(b => {
                sommaConsumo += parseFloat(b.consumo) || 0;
                sommaTotale += parseFloat(b.totale) || 0;

                const tr = document.createElement('tr');
                
                // Formattazione data italiana
                const dataFormat = new Date(b.scadenza).toLocaleDateString('it-IT');
                
                // Formattazione valuta
                const totaleFormat = parseFloat(b.totale).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
                
                tr.innerHTML = `
                    <td><span class="fattura-id">${b.numero}</span></td>
                    <td><span class="tag tag-${b.tipo}">${b.tipo}</span></td>
                    <td>${dataFormat}</td>
                    <td style="font-size:0.85em;">${b.periodo || '-'}</td>
                    <td><div class="note-text" title="${b.note}">${b.note || '-'}</div></td>
                    <td>${b.consumo} ${getUnita(b.tipo)}</td>
                    <td style="font-weight:bold; color:var(--dark);">${totaleFormat}</td>
                    <td>${b.prezzoUnitario} ‚Ç¨</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <a href="${b.link || '#'}" target="_blank" class="action-btn link-btn" title="Apri PDF" style="${!b.link ? 'opacity:0.2; pointer-events:none;' : ''}">üìÑ</a>
                        <button class="action-btn edit-btn" onclick="modificaBolletta('${b.id}')" title="Modifica">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="eliminaBolletta('${b.id}')" title="Elimina">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Aggiorna Footer Totali
            document.getElementById('footConsumo').innerText = sommaConsumo.toFixed(2);
            document.getElementById('footTotale').innerText = sommaTotale.toLocaleString('it-IT', {style:'currency', currency:'EUR'});
        }

        function getUnita(tipo) {
            if(tipo === 'Energia') return 'kWh';
            if(tipo === 'Gas') return 'Smc';
            if(tipo === 'Acqua') return 'mc';
            return '';
        }

        function popolaFiltroAnni() {
            const select = document.getElementById('filtroAnno');
            // Salva selezione attuale se possibile
            const valAttuale = select.value;
            
            // Pulisci (lascia solo "Tutti")
            select.innerHTML = '<option value="Tutti">üìÖ Tutti gli anni</option>';
            
            const anni = new Set();
            listaBollette.forEach(b => {
                if(b.scadenza) {
                    anni.add(new Date(b.scadenza).getFullYear());
                }
            });

            // Converti in array, ordina decrescente e crea opzioni
            Array.from(anni).sort().reverse().forEach(anno => {
                const opt = document.createElement('option');
                opt.value = anno;
                opt.innerText = anno;
                select.appendChild(opt);
            });

            // Ripristina selezione se esiste ancora, altrimenti Tutti
            if ([...select.options].some(o => o.value === valAttuale)) {
                select.value = valAttuale;
            }
        }

        // --- GESTIONE FORM (CRUD) ---

        function apriFormInserimento() {
            document.getElementById('form-wrapper').style.display = 'block';
            document.getElementById('form-title').innerText = "Inserisci Bolletta";
            document.getElementById('bollettaForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('statusMsg').innerText = "Nessun file selezionato";
            // Default su Energia
            selezionaTipo('Energia', document.querySelector('.type-btn'));
            // Scroll to form
            document.getElementById('form-wrapper').scrollIntoView({ behavior: 'smooth' });
        }

        function chiudiForm() {
            document.getElementById('form-wrapper').style.display = 'none';
        }

        function selezionaTipo(tipo, btn) {
            tipoSelezionato = tipo;
            // Aggiorna UI bottoni
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            else {
                // Se chiamata via codice senza passare il this
                const btns = document.querySelectorAll('.type-btn');
                if(tipo === 'Energia') btns[0].classList.add('active');
                if(tipo === 'Gas') btns[1].classList.add('active');
                if(tipo === 'Acqua') btns[2].classList.add('active');
            }
            
            document.getElementById('unitaMisura').innerText = getUnita(tipo);
        }

        function calcolaMedia() {
            const tot = parseFloat(document.getElementById('totalePagare').value);
            const cons = parseFloat(document.getElementById('consumo').value);
            const out = document.getElementById('prezzoMedio');
            
            if (tot > 0 && cons > 0) {
                out.value = (tot / cons).toFixed(4);
            } else {
                out.value = '';
            }
        }

        function salvaBolletta(event) {
            event.preventDefault();
            
            const idEsistente = document.getElementById('editId').value;
            
            const nuovaBolletta = {
                id: idEsistente || Date.now().toString(), // Genera ID univoco se nuovo
                numero: document.getElementById('numBolletta').value,
                tipo: tipoSelezionato,
                scadenza: document.getElementById('dataScadenza').value,
                periodo: document.getElementById('periodo').value,
                totale: parseFloat(document.getElementById('totalePagare').value),
                consumo: parseFloat(document.getElementById('consumo').value),
                prezzoUnitario: document.getElementById('prezzoMedio').value,
                link: document.getElementById('linkBolletta').value,
                note: document.getElementById('noteBolletta').value
            };

            if (idEsistente) {
                // Modifica
                const index = listaBollette.findIndex(b => b.id === idEsistente);
                if (index !== -1) {
                    listaBollette[index] = nuovaBolletta;
                }
            } else {
                // Nuovo inserimento
                listaBollette.push(nuovaBolletta);
            }

            salvaDatiLocali();
            renderizzaTabella();
            popolaFiltroAnni();
            chiudiForm();
        }

        function modificaBolletta(id) {
            const item = listaBollette.find(b => b.id === id);
            if (!item) {
                alert("Errore: bolletta non trovata.");
                return;
            }

            apriFormInserimento();
            document.getElementById('form-title').innerText = "Modifica Bolletta";
            document.getElementById('editId').value = item.id;
            
            // Popola campi
            document.getElementById('numBolletta').value = item.numero;
            document.getElementById('dataScadenza').value = item.scadenza;
            document.getElementById('periodo').value = item.periodo;
            document.getElementById('totalePagare').value = item.totale;
            document.getElementById('consumo').value = item.consumo;
            document.getElementById('prezzoMedio').value = item.prezzoUnitario;
            document.getElementById('linkBolletta').value = item.link || '';
            document.getElementById('noteBolletta').value = item.note || '';
            
            // Seleziona tipo
            selezionaTipo(item.tipo, null);
        }

        function eliminaBolletta(id) {
            if(confirm("Sei sicuro di voler eliminare questa bolletta?")) {
                listaBollette = listaBollette.filter(b => b.id !== id);
                salvaDatiLocali();
                renderizzaTabella();
                popolaFiltroAnni();
            }
        }

        // --- GESTIONE PDF (Stub per lettura automatica) ---
        // Nota: Richiede logica complessa con PDF.js, qui metto una base funzionante 
        // che avvisa l'utente
        async function gestisciFilePDF(input) {
            const file = input.files[0];
            if(!file) return;

            document.getElementById('statusMsg').innerText = "Analisi in corso...";
            document.getElementById('statusMsg').style.color = "orange";

            // Simulazione lettura (per implementazione reale serve parsing testo pdf.js)
            // Qui assumiamo che l'utente compili a mano se il parsing fallisce, 
            // o implementiamo una logica base se necessario.
            
            try {
                // Codice placeholder per PDF.js
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                const textItems = textContent.items.map(item => item.str).join(' ');

                console.log("Testo PDF estratto:", textItems);
                
                // Esempio banale di estrazione dati (da adattare al format A2A specifico)
                // Questa √® la parte pi√π delicata che dipende dal layout esatto del PDF
                
                document.getElementById('statusMsg').innerText = "Lettura completata (Verifica i dati)";
                document.getElementById('statusMsg').style.color = "green";
                
            } catch (e) {
                console.error(e);
                document.getElementById('statusMsg').innerText = "Errore lettura PDF. Inserisci manualmente.";
                document.getElementById('statusMsg').style.color = "red";
            }
        }
    </script>
</body>
</html>
